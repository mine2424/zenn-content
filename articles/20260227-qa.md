---
title: "テストコードを「負債」にしないために — 保守性の高いテスト設計の考え方"
emoji: "🧪"
type: "tech"
topics: ["testing", "qa", "tdd", "softwaredesign"]
published: false
---

## テストは本当に「安全網」になっているか

「テストを書けば安心」という言葉をよく聞きます。しかし実際の現場では、テストが増えるほど開発が遅くなるという逆説的な状況が起きることがあります。

リファクタリングするたびにテストが大量に壊れる。コードを変更するより先にテストを直す作業に時間を取られる。CI が真っ赤で、どれが本当のバグかわからない——こういった状況は、テストが「安全網」ではなく「足枷」になっているサインです。

問題はテストを書いていないことではなく、**どんなテストを書くか**の設計思想にあります。

## 「何をテストするか」の根本に立ち返る

テスト設計の問題の多くは、「実装をテストしている」ことから来ています。

実装とは、コードがどのように動くかの詳細です。どのメソッドが呼ばれるか、内部の変数がどんな値を持つか、処理がどの順番で実行されるか。これをテストすると、コードを動かしたまま内部をリファクタリングしただけでテストが壊れます。

本来テストすべきは**仕様**です。このシステムはどんな入力に対してどんな出力を返すか。ユーザーはこのボタンを押したら何が起きるか。仕様をテストしていれば、内部実装を自由に変えられます。それがテストの本来の役割——変化に対する安全網——です。

この違いを意識するだけで、テストの保守性は大きく変わります。

## テストの「粒度」を意識する

テストを書くとき、無意識のうちに「書きやすい単位」でテストを切りがちです。しかし書きやすさと、テストとしての価値は必ずしも一致しません。

**粒度が細かすぎる問題**

関数一つひとつに対してテストを書くと、実装の詳細と密結合したテストが生まれます。内部実装を変えるたびにテストも変える必要があり、保護するはずのリファクタリングに対してむしろ障壁になります。

**粒度が大きすぎる問題**

逆にシステム全体を通すE2Eテストだけを書くと、テストが遅くなり、失敗したときにどこが悪いのかの特定が難しくなります。

適切な粒度は「一つの振る舞いの単位」です。この振る舞いという概念が重要で、ユーザーやビジネスの観点から意味を持つ最小の動作の単位でテストを切ることが、保守性と価値のバランスが取れたテスト設計につながります。

## Given-When-Thenで仕様を書く

テストコードを「コードのチェック」ではなく「仕様書」として書くとき、Given-When-Then（GWT）という構造が役に立ちます。

- **Given（前提条件）**: テスト対象がどういう状態にあるか
- **When（操作）**: 何をしたか
- **Then（期待結果）**: どうなるべきか

この構造に沿って書くと、テストが読んで意味のわかるドキュメントになります。テストが失敗したとき、「どういう状況で」「何をしたら」「何が期待と違ったか」が一目でわかります。

また、この形式で考えると「このテストで本当に検証したいことは何か」が整理されます。Whenが複数あるテストは設計の臭い（テストが複数の振る舞いを一気に確認しようとしている）として気づけます。

## テストダブルとの向き合い方

テストを書いていると、外部サービスやデータベースへの依存をどうするかという問題に直面します。そこで登場するのがモック（Mock）やスタブ（Stub）などのテストダブルです。

テストダブルは強力ですが、使いすぎると問題が起きます。本物の実装と乖離したモックで作られた「夢の世界」でテストが通っても、本番では動かないというケースです。

テストダブルを使う判断基準は「外部依存がテストの価値を下げているか」です。

ネットワーク越しのAPI呼び出しは遅くて不安定なので、テストダブルで差し替えるのは合理的です。しかし内部のクラスや関数をモックにしすぎると、実装の詳細をテストしているのと同じ問題が起きます。

「何をモックにして何を本物を使うか」は、テスト設計の中でも特に判断が難しい部分です。一般的な指針は「境界線（I/O、外部サービス）ではモックを使い、内部ロジックは本物を使う」です。

## 「壊れたテスト」を放置しない文化

テストの保守性を語るうえで、技術的な話と同じくらい重要なのが文化の話です。

テストが壊れたとき、直す代わりに「スキップ」「コメントアウト」「always pass」にする——これが組織の中でまかり通ると、テストスイートは急速に信頼性を失います。

壊れたテストを放置することのコストは、その場では見えにくい。しかし時間が経つほど蓄積し、「テストがあっても意味がない」という空気がチームに広がります。

壊れたテストはバグのシグナルか、設計の課題のシグナルです。どちらにせよ、向き合う価値があります。テストをすぐに直せない事情があるなら、なぜ直せないのかを記録して可視化することが大切です。

## まとめ：テストは「書く」より「設計する」もの

テストの保守性を高めるために重要なことをまとめます。

- 実装ではなく仕様をテストする
- 振る舞いの単位でテストの粒度を決める
- Given-When-Thenで「何をテストするか」を明確にする
- テストダブルは境界線だけで使う
- 壊れたテストを放置しない文化を作る

テストコードは一度書いたら終わりではなく、プロダクトコードと同様にメンテナンスが必要なコードです。この認識を持って「設計する」意識でテストに向き合うことが、長期的に価値を発揮するテストスイートを作る鍵です。
