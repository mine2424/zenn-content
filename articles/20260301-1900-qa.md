---
title: "E2Eテストの「どこから書くか」問題：テスト優先度の考え方"
emoji: "🎯"
type: "tech"
topics: ["e2e", "test", "qa", "playwright", "automation"]
published: false
---

## はじめに

「E2Eテストを導入しよう」という話になったとき、最初に直面する問いがある。

**「何から書けばいいか」**

機能ごとに書く？ページごとに書く？ユーザーストーリーベースで書く？  
答えは「場合による」だが、それだけでは実務の指針にならない。

この記事では、E2Eテストの優先度をどう考えるか、実際の設計判断の根拠となるフレームワークを整理していく。

## E2Eテストの位置づけを再確認する

テストピラミッドという考え方がある。ユニットテスト → 統合テスト → E2Eテストという三層構造で、上に行くほど少数精鋭で運用するべきというモデルだ。

E2Eテストはこのピラミッドの頂点にある。その特性を整理すると：

- **ブラウザ・ネットワーク・DB・UIすべてを通した動作確認**が可能
- 実行時間が長く、メンテナンスコストが高い
- 偽陽性（flaky test）が起きやすい
- 「ユーザー視点での動作」を最もリアルに確認できる

このトレードオフを理解した上で、「どこに使うか」を絞る判断が求められる。

## なぜ「全部に書く」はうまくいかないのか

E2Eテストを初めて導入するチームがよく陥るパターンは、「カバレッジを高めよう」という意識から全機能にテストを書こうとすることだ。

これがうまくいかない理由は3つある。

**1. テストスイートの実行時間が爆発する**  
E2Eテストは1件あたり数秒から数十秒かかる。100件になると数時間かかるケースも珍しくない。CI/CDパイプラインがボトルネックになり、開発速度を下げる。

**2. メンテナンスの地獄**  
UIは頻繁に変わる。ボタンのラベル変更、要素の移動、レイアウトの調整──これらのたびにテストが壊れる。件数が多ければ多いほど、修正コストは増大し、やがて「誰もテストを直さない」状態に陥る。

**3. フレーキーネスの蓄積**  
ネットワーク遅延やレンダリングのタイミングに依存するE2Eテストは、環境やタイミングによって失敗する「flaky test」が発生しやすい。テストが信頼されなくなると、CIが赤でも誰も気にしなくなる。

## 優先すべきテストの選び方

では何を優先するか。以下の3軸で考えると整理しやすい。

### 軸1：ビジネスクリティカルなフロー

ユーザーが最も重要な価値を受け取る一連の操作を「クリティカルパス」と呼ぶ。ECサイトなら「商品検索→カート追加→決済→完了」、SaaSなら「ログイン→主要機能の実行→結果確認」がこれにあたる。

クリティカルパスが壊れていると、ビジネスが機能しない。どんな小さなプロダクトでも、このフローだけは確実に守る必要がある。E2Eテストは、まずここから書く。

### 軸2：手動テストが苦痛なフロー

「毎リリース前に必ず手動で確認しているが、時間がかかって辛い」という作業は自動化の候補だ。

特に以下のようなものは優先度が高い：
- 複数ステップにまたがる複雑な操作
- 環境依存の設定が多い認証フロー
- サードパーティ連携（OAuth、決済、メール）の確認

人間が毎回やっている繰り返し作業をE2Eが代替することで、リリース工数が直接削減される。

### 軸3：過去にバグが多かったフロー

実際にバグが発生した箇所は、将来も同様の問題が起きやすい。過去のバグ履歴を見て、同じ箇所での回帰バグを防ぐためにE2Eを書くのは理にかなっている。

「このページは毎回何かしらバグが出る」という感覚をチームが持っている場所は、E2Eの重点投資先だ。

## テスト設計の粒度：シナリオ vs ステップ

E2Eテストを書くとき、どの粒度で1つのテストケースを定義するかも重要な判断だ。

**シナリオ型**は、ユーザーの行動を一連のストーリーとして書く。「新規ユーザーが登録してプロフィールを設定するまで」という形式だ。現実のユーザー行動に近く、ビジネス要件とのトレーサビリティが取りやすい。ただし1件が長くなり、途中の失敗がどこで起きたか特定しにくい。

**ステップ型**は、より小さな単位でテストを分割する。「ログイン」「商品検索」「カート追加」を別々のテストとして書く。失敗の特定がしやすく、独立性も高い。ただしステートの管理（ログイン状態の共有など）が複雑になる。

実務では、クリティカルパスはシナリオ型で書き、個別機能の確認はステップ型で補完するハイブリッドアプローチが有効なことが多い。

## Playwrightが変えたE2E設計の常識

近年、PlaywrightがE2Eテストのデファクトスタンダードになりつつある。その理由のひとつが、テスト設計に関係する`locator`の思想だ。

```typescript
// 脆いセレクタ（DOMの構造に依存）
await page.click('.container > div:nth-child(2) > button');

// Playwrightが推奨する堅牢なロケータ
await page.getByRole('button', { name: '送信' }).click();
```

`getByRole`や`getByText`といったロケータは、DOMの構造ではなくユーザーが実際に認識する要素（ロール・テキスト）に基づいてセレクトする。これにより、UI変更に強いテストが書けるようになった。

さらに、PlaywrightのAuto-waiting機能は「要素が表示されるまで待つ」を自動でやってくれるため、明示的な`sleep`や`waitFor`が大幅に減り、フレーキーネスの原因を根本から減らせる。

## まとめ：量より質の戦略

E2Eテストは「多ければ良い」ものではない。少数の厳選されたテストが確実に実行され、チームに信頼されている状態が理想だ。

まず始める場所はクリティカルパス。次に、手動で繰り返している辛い確認作業。そして、過去のバグ発生箇所。

この3軸で対象を選び、テストの量を絞り込むことで、高速で信頼性の高いテストスイートが育っていく。

「E2Eテストを書く」ことよりも「E2Eテストを維持し続けられる体制を作る」ことの方が、長期的には重要だ。そのための第一歩が、優先度の設計から始めることにある。
