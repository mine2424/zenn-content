---
title: "「壊れやすいE2Eテスト」から脱却するための思考法"
emoji: "🧪"
type: "tech"
topics: ["qa", "e2e", "test", "playwright", "品質保証"]
published: false
---

## はじめに

E2Eテストを書いたことがある人なら、誰もが一度は経験したことがあるはずです——「昨日まで通っていたテストが、今日突然落ちた」という体験。UIの微妙な変更、タイミングの問題、環境の差異。E2Eテストは強力なツールですが、その維持コストの高さから「書いては壊れ、直しては壊れ」という悪循環に陥るチームも少なくありません。

この記事では、E2Eテストが壊れやすくなる根本的な原因と、それを回避するための思考の枠組みを整理します。

---

## なぜE2Eテストは壊れやすいのか

壊れやすいE2Eテストには、多くの場合、共通した構造的な問題があります。

### 実装の詳細に依存している

最も多い原因は、テストが「ユーザーの意図」ではなく「UIの実装詳細」をテストしていることです。

たとえば、「ログインボタンをクリックする」という操作をテストするとき、

```python
# 実装詳細に依存したセレクター
page.click("#login-btn-v2-redesigned")
```

のように、CSSクラスや内部IDで要素を特定していると、デザインのリニューアルや開発者がクラス名を変えるだけでテストが壊れます。

### タイミングへの依存

非同期処理が絡むUIでは、「要素が表示されるまで待つ」というロジックが必要です。しかし `sleep(1000)` のような固定待機を挟んでいると、実行環境によって遅すぎたり早すぎたりします。これはフレイキーテスト（結果が不安定なテスト）の典型的な原因です。

### テストの独立性がない

あるテストが他のテストの状態（ログイン済みセッション、作成済みデータなど）に依存していると、実行順序が変わっただけでテストが落ちます。

---

## 思考の転換：「ユーザーの視点」で書く

壊れにくいE2Eテストへの最初の一歩は、テストの主語を「UI要素」から「ユーザー」に変えることです。

**「このボタンをクリックする」ではなく「ユーザーがログインしようとする」**
**「このInputに値を入力する」ではなく「ユーザーが商品を検索する」**

この視点の違いは、セレクターの選び方に直結します。PlaywrightやCypressといったモダンなE2Eフレームワークでは、アクセシビリティ属性（ARIAロール）や `data-testid` 属性を使ってユーザー意図ベースで要素を特定することが推奨されています。

```python
# ユーザー視点のセレクター
page.get_by_role("button", name="ログイン")
page.get_by_label("メールアドレス")
```

これらは、UIのスタイルが変わっても、「ログインボタン」という意味が変わらない限り壊れません。

---

## Page Object Modelという抽象化の力

もう一つ強力な考え方が **Page Object Model（POM）** です。

POMとは、各ページの操作を専用のクラスやモジュールに閉じ込め、テストコードからは抽象化されたインターフェースだけを使う設計パターンです。

たとえばログインページであれば、`LoginPage` というオブジェクトが「メールアドレスの入力」「パスワードの入力」「ログインボタンのクリック」「エラーメッセージの取得」といった操作をカプセル化します。

この設計の利点は、UIが変わったときに変更箇所が `LoginPage` オブジェクトの中だけで済むことです。テストコード自体には手を加える必要がありません。

変更の影響範囲を一点に集約する——これはE2Eテストにおける「単一責任の原則」と言えます。

---

## フレイキーテストとの向き合い方

どれだけ丁寧に書いても、E2Eテストは本質的にフレイキー（不安定）になりやすい性質を持っています。これはUIが非同期・非決定的なものを扱うからです。

大切なのは「フレイキーテストをゼロにする」という幻想を捨て、**「フレイキーテストを検知・管理する仕組みを作る」** という発想に切り替えることです。

具体的には、

- **リトライ戦略**：テストが落ちたら自動的に1〜2回再実行し、それでも落ちる場合だけ失敗とする
- **フレイキーレジスター**：不安定なテストをタグで管理し、改善の優先度付けに使う
- **実行統計の収集**：過去の成功率を記録し、成功率80%以下のテストは自動的にレビュー対象にする

こういった運用の仕組みがあることで、テストスイート全体の健全性を保ちながら現実的に運用できます。

---

## テストピラミッドを再考する

E2Eテストを適切に機能させるためには、より広い文脈——テストピラミッド——を意識することも重要です。

テストピラミッドとは、単体テスト・統合テスト・E2Eテストをそれぞれの速度・コスト・信頼性に応じて適切な比率で組み合わせる考え方です。

E2Eテストは最も現実に近い検証ができますが、実行速度が遅く、維持コストも高い。そのため**クリティカルなユーザーフローのみをE2Eでカバーし、それ以外は単体テストや統合テストで補う**という戦略が健全です。

「何をE2Eでテストすべきか」という問いに答えるためのシンプルな基準は、「このフローが壊れたとき、ユーザーがサービスを使えなくなるか？」です。課金フロー、ログイン、核心的なコア機能——そういったものだけをE2Eの対象とすることで、テストスイートをスリムかつ価値のある状態に保てます。

---

## まとめ

壊れにくいE2Eテストを書くための思考法をまとめます。

1. **ユーザーの意図でテストを書く** — UIの実装詳細ではなく、ユーザーが「何をしようとしているか」を主語にする
2. **セレクターをARIAロールやtestidに統一する** — デザイン変更に強い
3. **Page Object Modelで変更を一点集約する** — 保守コストを局所化する
4. **フレイキーテストを管理する仕組みを作る** — ゼロにしようとしない
5. **E2Eでテストする範囲を絞る** — クリティカルなフローに集中する

E2Eテストは「多く書けばいい」ものではありません。少なくとも、正しい場所に、正しい設計で書かれたテストこそが、チームに長期的な安心をもたらします。
