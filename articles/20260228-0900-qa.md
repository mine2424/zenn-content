---
title: "E2Eテストの「壊れやすさ」と向き合う：フレイキーテスト撲滅の考え方"
emoji: "🔧"
type: "tech"
topics: ["qa", "e2e", "テスト自動化", "playwright"]
published: false
---

## はじめに

E2Eテストを導入したプロジェクトで、よく耳にする悩みがあります。

「テストが落ちたけど、再実行したら通った」
「同じテストが月曜は緑で金曜は赤になる」
「CIがよく落ちるから、もう誰もテスト結果を信じていない」

これらは **フレイキーテスト（Flaky Test）** と呼ばれる現象です。テスト自体は正しく書かれているように見えるのに、実行のたびに結果が変わる。開発チームにとって、これは単なる「テストのバグ」以上の深刻な問題です。

この記事では、フレイキーテストがなぜ発生するのか、その根本原因をどう考えるべきか、そして撲滅に向けた設計の考え方を整理します。

---

## フレイキーテストが深刻な理由

バグを1つ残すことと、フレイキーなテストを1つ残すことを比べると、後者のほうが長期的なダメージが大きいことがあります。

バグは「ある」か「ない」かが明確です。しかしフレイキーテストは「信頼性の喪失」を引き起こします。テスト結果が信頼できなくなると、開発者はCIの赤信号を無視し始めます。「どうせまたフレイキーだろう」という慣れが生まれ、本物のバグが見落とされるリスクが高まります。

テストの価値は「正しく動くことを証明する」ことにありますが、フレイキーテストはその証明を無効化します。**テストスイートへの信頼を守ることは、テスト数を増やすことより重要**です。

---

## フレイキーテストの主な原因を分類する

フレイキーテストには、いくつかのパターンがあります。原因を正確に把握することが対処の第一歩です。

### 1. タイミング依存

最も多いケースです。「要素が表示されるまで待つ」処理が、環境によって所要時間が変わるため、タイムアウトしたりしなかったりします。

固定時間のスリープ（`sleep(2000)`）はこの問題の代表的な「悪い解法」です。ローカルでは通過してもCI環境では時間が足りず、逆にCI環境に合わせると無駄な待機時間が増える。根本解決にならないうえ、テストを遅くします。

正しいアプローチは、**状態を待つ**ことです。「2秒待つ」ではなく「この要素が表示されるまで待つ」「このAPIレスポンスが返るまで待つ」という条件ベースの待機です。

### 2. テスト間の依存関係

前のテストの実行結果が、次のテストの動作に影響を与えるケースです。データベースの状態、セッション、ローカルストレージなどが原因になりがちです。

「テストAが先に実行された場合だけテストBが通る」という状況は、テストの順序に依存していることを意味します。E2Eテストは各テストが独立して実行できる必要があります。

### 3. 外部サービスへの依存

実際のAPIや外部サービスに接続するE2Eテストは、そのサービスの可用性や応答時間に左右されます。外部の障害がテスト結果に影響するのは、テストとして望ましくありません。

### 4. テスト環境の不安定さ

データベースの初期化が不完全、テスト用のシードデータが毎回異なる、環境変数の設定ミスなど、テスト環境そのものの問題がフレイキーを引き起こすこともあります。

---

## 「待機戦略」の設計を見直す

フレイキーテストの原因の大半はタイミング依存です。したがって、待機戦略を正しく設計することが最重要の対策になります。

### 明示的なアサーションを待機条件にする

```typescript
// ❌ 固定時間待機（アンチパターン）
await page.waitForTimeout(3000);
await expect(page.getByText("保存完了")).toBeVisible();

// ✅ 状態ベースの待機（推奨）
await expect(page.getByText("保存完了")).toBeVisible({ timeout: 10000 });
```

Playwrightのような現代的なE2Eフレームワークは、アサーションそのものに自動リトライ機能を持っています。要素が現れるまで指定タイムアウトの範囲で繰り返し確認し、現れた時点でパスします。この仕組みを最大限活用するのが正しいアプローチです。

### ネットワーク待機との組み合わせ

UIの変化がAPIレスポンスに依存する場合、ネットワークリクエストの完了を待ってからUIの検証を行うのが確実です。「ボタンを押した後のUIの変化」だけを見るのではなく、「APIが返ってきた後のUIの変化」を検証することで、ネットワーク遅延による揺れを吸収できます。

---

## テストの独立性を設計に組み込む

各テストが独立して実行できるようにするには、以下の原則を守ることが重要です。

### テストごとにデータを作成・破棄する

テストの開始時に必要なデータをセットアップし、終了後にクリーンアップする。他のテストが作ったデータに依存しない。これを徹底するだけで、テスト間干渉による多くのフレイキーは解消します。

### テスト専用ユーザー・専用データを使う

本番や開発環境のデータと混在させず、テスト専用のユーザーアカウントやデータセットを使いましょう。「誰かが手動でデータを変えてしまった」という干渉を防げます。

### 順序非依存を確認する

テストをランダム順で実行してみることは有効なチェック方法です。並び順を変えても全テストが通るなら、独立性が保たれている証拠です。

---

## フレイキーテストを検出・追跡する仕組み

発生したフレイキーテストを放置すると、雪だるま式に増えていきます。継続的に検出・追跡する仕組みを整えることが大切です。

### 失敗したテストを自動で記録する

CIが落ちたとき、どのテストが何回失敗したかを記録します。同じテストが繰り返し「たまに落ちる」パターンを示していれば、それはフレイキーの候補です。

### フレイキー専用のラベルを付ける

フレイキーと特定されたテストには専用のタグを付け、別扱いにします。「フレイキーテストはCIブロッカーにしない」という運用と組み合わせることで、チームが本物の失敗を見逃さない状態を維持できます。ただし、タグを付けたまま放置するのではなく、修正のバックログとして管理することが重要です。

---

## テストへの「信頼の口座」という考え方

フレイキーテストへの向き合い方として、「信頼の口座」というメタファーが役立ちます。テストスイートには信頼残高があり、テストが正確に失敗を捕捉するたびに残高が増え、誤検知（フレイキー）が起きるたびに残高が減ります。

残高がゼロになると、チームはテスト結果を見なくなります。E2Eテストを導入した意味がなくなります。

逆に残高が高い状態では、CIが赤になったとき全員が真剣に向き合います。「本物のバグかもしれない」という信頼が、テストスイートを機能させます。

フレイキーテストの撲滅は、テクニカルな問題である以前に、**チームのテストへの信頼を守る**という文化的な取り組みでもあります。

---

## まとめ

フレイキーテストに向き合うための考え方を整理します。

- **原因を分類する**：タイミング依存・テスト間依存・外部依存・環境問題
- **待機戦略を見直す**：固定スリープをやめ、状態ベースの待機に切り替える
- **独立性を設計する**：各テストがデータを自己完結して持ち、順序に依存しない
- **検出・追跡する**：フレイキーを可視化し、放置しない仕組みを作る
- **信頼を守る**：フレイキーテストはチームの信頼を蝕むと認識する

テストの数よりも、テストへの信頼が品質を守ります。フレイキーテストを「仕方ない」と諦めず、設計の問題として真剣に向き合いましょう。
